var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(e,K,M){e!=Array.prototype&&e!=Object.prototype&&(e[K]=M.value)};$jscomp.getGlobal=function(e){return"undefined"!=typeof window&&window===e?e:"undefined"!=typeof global&&null!=global?global:e};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.polyfill=function(e,K,M,g){if(K){M=$jscomp.global;e=e.split(".");for(g=0;g<e.length-1;g++){var fa=e[g];fa in M||(M[fa]={});M=M[fa]}e=e[e.length-1];g=M[e];K=K(g);K!=g&&null!=K&&$jscomp.defineProperty(M,e,{configurable:!0,writable:!0,value:K})}};$jscomp.arrayIteratorImpl=function(e){var K=0;return function(){return K<e.length?{done:!1,value:e[K++]}:{done:!0}}};$jscomp.arrayIterator=function(e){return{next:$jscomp.arrayIteratorImpl(e)}};$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.SymbolClass=function(e,K){this.$jscomp$symbol$id_=e;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:K})};$jscomp.SymbolClass.prototype.toString=function(){return this.$jscomp$symbol$id_};
$jscomp.Symbol=function(){function e(M){if(this instanceof e)throw new TypeError("Symbol is not a constructor");return new $jscomp.SymbolClass($jscomp.SYMBOL_PREFIX+(M||"")+"_"+K++,M)}var K=0;return e}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var e=$jscomp.global.Symbol.iterator;e||(e=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("Symbol.iterator"));"function"!=typeof Array.prototype[e]&&$jscomp.defineProperty(Array.prototype,e,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}});$jscomp.initSymbolIterator=function(){}};
$jscomp.initSymbolAsyncIterator=function(){$jscomp.initSymbol();var e=$jscomp.global.Symbol.asyncIterator;e||(e=$jscomp.global.Symbol.asyncIterator=$jscomp.global.Symbol("Symbol.asyncIterator"));$jscomp.initSymbolAsyncIterator=function(){}};$jscomp.iteratorPrototype=function(e){$jscomp.initSymbolIterator();e={next:e};e[$jscomp.global.Symbol.iterator]=function(){return this};return e};
$jscomp.iteratorFromArray=function(e,K){$jscomp.initSymbolIterator();e instanceof String&&(e+="");var M=0,g={next:function(){if(M<e.length){var fa=M++;return{value:K(fa,e[fa]),done:!1}}g.next=function(){return{done:!0,value:void 0}};return g.next()}};g[Symbol.iterator]=function(){return g};return g};$jscomp.polyfill("Array.prototype.entries",function(e){return e?e:function(){return $jscomp.iteratorFromArray(this,function(e,M){return[e,M]})}},"es6","es3");
(function(e){if("function"===typeof define&&define.amd)define(["JSRootCore","d3","JSRootPainter.hist","threejs","threejs_all"],e);else if("object"===typeof exports&&"undefined"!==typeof module){var K=require("./JSRootCore.js");e(K,require("d3"),require("./JSRootPainter.hist.js"),require("three"),require("./three.extra.min.js"),K.nodejs||"undefined"==typeof document?K.nodejs_document:document)}else{if("undefined"==typeof JSROOT)throw Error("JSROOT is not defined","JSRootPainter.hist3d.js");if("object"!=
typeof d3)throw Error("This extension requires d3.js","JSRootPainter.hist3d.js");if("undefined"==typeof THREE)throw Error("THREE is not defined","JSRoot3DPainter.js");e(JSROOT,d3,JSROOT,THREE,THREE)}})(function(e,K,M,g,fa,ja){function Q(a){e.THistPainter.call(this,a);this.mode3d=!0}function X(a){e.TObjectPainter.call(this,a)}e.sources.push("hist3d");"undefined"==typeof ja&&"object"==typeof window&&(ja=window.document);if("undefined"===typeof e.THistPainter)throw Error("JSROOT.THistPainter is not defined",
"JSRootPainter.hist3d.js");e.TFramePainter.prototype.SetCameraPosition=function(a,b){var c=Math.max(.75*this.size_xy3d,this.size_z3d);b&&this.camera.position.set(-1.6*c,-3.5*c,1.4*this.size_z3d);if(!(!a||!b&&this.zoom_changed_interactive||isNaN(a.fTheta)||isNaN(a.fPhi)||a.fTheta===this.camera_Theta&&a.fPhi===this.camera_Phi)){c=3*Math.max(this.size_xy3d,this.size_z3d);b=(-a.fPhi-90)/180*Math.PI;var d=a.fTheta/180*Math.PI;this.camera_Phi=a.fPhi;this.camera_Theta=a.fTheta;this.camera.position.set(c*
Math.cos(b)*Math.cos(d),c*Math.sin(b)*Math.cos(d),this.size_z3d+c*Math.sin(d));b=!0}b&&this.camera.lookAt(this.lookat)};e.TFramePainter.prototype.Create3DScene=function(a){if(void 0!==a&&0>a)this.mode3d&&(this.TestAxisVisibility(null,this.toplevel),this.clear_3d_canvas(),e.Painter.DisposeThreejsObject(this.scene),this.control&&this.control.Cleanup(),this.renderer&&(this.renderer.dispose&&this.renderer.dispose(),this.renderer.context&&delete this.renderer.context),delete this.size_xy3d,delete this.size_z3d,
delete this.tooltip_mesh,delete this.scene,delete this.toplevel,delete this.camera,delete this.pointLight,delete this.renderer,delete this.control,"render_tmout"in this&&(clearTimeout(this.render_tmout),delete this.render_tmout),this.mode3d=!1);else if(this.mode3d=!0,"toplevel"in this)this.scene.remove(this.toplevel),e.Painter.DisposeThreejsObject(this.toplevel),delete this.tooltip_mesh,delete this.toplevel,this.control&&this.control.HideTooltip(),a=new g.Object3D,this.scene.add(a),this.toplevel=
a,this.Resize3D(),this.SetCameraPosition(this.root_pad(),!1);else{this.usesvg=e.Painter.UseSVGFor3D();a=this.size_for_3d(this.usesvg?3:void 0);this.size_z3d=100;this.size_xy3d=10<a.height&&10<a.width?Math.round(a.width/a.height*this.size_z3d):this.size_z3d;this.scene=new g.Scene;this.toplevel=new g.Object3D;this.scene.add(this.toplevel);this.scene_width=a.width;this.scene_height=a.height;this.camera=new g.PerspectiveCamera(45,this.scene_width/this.scene_height,1,40*this.size_z3d);this.camera_Theta=
this.camera_Phi=30;this.pointLight=new g.PointLight(16777215,1);this.camera.add(this.pointLight);this.pointLight.position.set(this.size_xy3d/2,this.size_xy3d/2,this.size_z3d/2);this.lookat=new g.Vector3(0,0,.8*this.size_z3d);this.camera.up=new g.Vector3(0,0,1);this.scene.add(this.camera);this.SetCameraPosition(this.root_pad(),!0);var b=e.Painter.Create3DRenderer(this.scene_width,this.scene_height,this.usesvg,4==a.can3d);this.renderer=b.renderer;this.webgl=b.usewebgl;this.add_3d_canvas(a,b.dom);this.first_render_tm=
0;this.enable_highlight=!1;if(!e.BatchMode){this.control=e.Painter.CreateOrbitControl(this,this.camera,this.scene,this.renderer,this.lookat);var c=this,d=this.main_painter();this.control.ProcessMouseMove=function(a){for(var b=null,d=null,k=null,e=0;e<a.length;++e)if(a[e].object.tooltip){if(b=a[e].object.tooltip(a[e])){d=a[e].object;break}}else a[e].object.zoom&&!k&&(k=a[e].object);b&&!b.use_itself&&(a=1E-4*c.size_xy3d,e=1E-4*c.size_z3d,(b.x1>b.x2||b.y1>b.y2||b.z1>b.z2)&&console.warn("check 3D hints coordinates"),
b.x1-=a,b.x2+=a,b.y1-=a,b.y2+=a,b.z1-=e,b.z2+=e);c.BinHighlight3D(b,d);return!b&&k&&c.Get3DZoomCoord?(d=k.GlobalIntersect(this.raycaster),b=k.zoom,d=c.Get3DZoomCoord(d,b),"z"===b&&k.use_y_for_z&&(b="y"),k=c.GetAxis(b),a={name:b,title:"TAxis",line:"any info",only_status:!0},k&&(a.name=k.fName,a.title=k.fTitle||"histogram TAxis object"),a.line=b+" : "+c.AxisAsText(b,d),a):b&&b.lines?b:""};this.control.ProcessMouseLeave=function(){c.BinHighlight3D(null)};this.control.ContextMenu=function(a,b){var c=
"hist",k=d;if(b)for(var e=0;e<b.length;++e){var m=b[e].object;if(m.zoom){c=m.zoom;break}if(m.painter&&"function"===typeof m.painter.ShowContextMenu){k=m.painter;break}}k.ShowContextMenu(c,a)}}}};e.TFramePainter.prototype.SetActive=function(a){this.control&&(this.control.enableKeys=a)};e.TFramePainter.prototype.Render3D=function(a){if(-1111===a){a=g.CreateSVGRenderer(!1,0,ja);a.setSize(this.scene_width,this.scene_height);a.render(this.scene,this.camera);if(a.makeOuterHTML){var b=ja.createElement("div");
b.innerHTML=a.makeOuterHTML();return b.childNodes[0]}return a.domElement}void 0===a&&(a=5);if(0>=a||this.usesvg||e.BatchMode){if("render_tmout"in this)clearTimeout(this.render_tmout);else if(-2222===a)return;void 0!==this.renderer&&(a=new Date,this.opt3d||(this.opt3d={FrontBox:!0,BackBox:!0}),this.TestAxisVisibility(this.camera,this.toplevel,this.opt3d.FrontBox,this.opt3d.BackBox),this.renderer.render(this.scene,this.camera),0===this.first_render_tm&&this.renderer instanceof g.SoftwareRenderer&&this.renderer.render(this.scene,
this.camera),e.Painter.AfterRender3D(this.renderer),b=new Date,delete this.render_tmout,0===this.first_render_tm&&(this.first_render_tm=b.getTime()-a.getTime(),this.enable_highlight=1200>this.first_render_tm&&this.IsTooltipAllowed(),console.log("First render tm = "+this.first_render_tm)))}else"render_tmout"in this||(this.render_tmout=setTimeout(this.Render3D.bind(this,0),a))};e.TFramePainter.prototype.Resize3D=function(){var a=this.size_for_3d(this.access_3d_kind());this.apply_3d_size(a);if(this.scene_width===
a.width&&this.scene_height===a.height||10>a.width||10>a.height)return!1;this.scene_width=a.width;this.scene_height=a.height;this.camera.aspect=this.scene_width/this.scene_height;this.camera.updateProjectionMatrix();this.renderer.setSize(this.scene_width,this.scene_height);return!0};e.TFramePainter.prototype.BinHighlight3D=function(a,b){var c=!1,d=null,z=!0,w=!a||void 0===a.x1||!this.enable_highlight;this.tooltip_selfmesh&&(z=this.tooltip_selfmesh!==b,this.tooltip_selfmesh.material.color=this.tooltip_selfmesh.save_color,
delete this.tooltip_selfmesh,c=!0);this.tooltip_mesh&&(d=this.tooltip_mesh,this.toplevel.remove(this.tooltip_mesh),delete this.tooltip_mesh,c=!0);if(w)c&&this.Render3D(),this.ProvideUserTooltip(null);else{if(a.use_itself)b.save_color=b.material.color,b.material.color=new g.Color(a.color),this.tooltip_selfmesh=b,c=z;else{c=!0;b=e.Painter.Box3D.Indexes;z=e.Painter.Box3D.Normals;w=e.Painter.Box3D.Vertices;var q=new g.Color(a.color?a.color:16711680),k=a.opacity||1;if(d){var u=d.geometry.attributes.position.array;
d.geometry.attributes.position.needsUpdate=!0;d.material.color=q;d.material.opacity=k}else{u=new Float32Array(3*b.length);var m=new Float32Array(3*b.length);d=new g.BufferGeometry;d.addAttribute("position",new g.BufferAttribute(u,3));d.addAttribute("normal",new g.BufferAttribute(m,3));q=new g.MeshBasicMaterial({color:q,opacity:k,flatShading:!0});d=new g.Mesh(d,q)}a.x1===a.x2&&console.warn("same tip X",a.x1,a.x2);a.y1===a.y2&&console.warn("same tip Y",a.y1,a.y2);a.z1===a.z2&&(a.z2=a.z1+1E-4);q=0;for(k=
-3;q<b.length;++q){var f=w[b[q]];u[3*q]=a.x1+f.x*(a.x2-a.x1);u[3*q+1]=a.y1+f.y*(a.y2-a.y1);u[3*q+2]=a.z1+f.z*(a.z2-a.z1);m&&(0===q%6&&(k+=3),m[3*q]=z[k],m[3*q+1]=z[k+1],m[3*q+2]=z[k+2])}this.tooltip_mesh=d;this.toplevel.add(d)}c&&this.Render3D();c&&a.$painter&&"function"==typeof a.$painter.RedrawProjection&&a.$painter.RedrawProjection(a.ix-1,a.ix,a.iy-1,a.iy);this.GetObject()&&this.ProvideUserTooltip({obj:this.GetObject(),name:this.GetObject().fName,bin:a.bin,cont:a.value,binx:a.ix,biny:a.iy,binz:a.iz,
grx:(a.x1+a.x2)/2,gry:(a.y1+a.y2)/2,grz:(a.z1+a.z2)/2})}};e.TFramePainter.prototype.TestAxisVisibility=function(a,b,c,d){function e(a,b){a<=k&&(a+=4);return a>k&&a<k+b}if(b&&b.children)for(var g=0;g<b.children.length;++g){var q=b.children[g];if(q.axis_draw)break;q=void 0}if(q)if(a){c=c?!0:!1;d=d?!0:!1;var k=1;g=a.position;0>g.x&&0<=g.y&&(k=2);0<=g.x&&0<=g.y&&(k=3);0<=g.x&&0>g.y&&(k=4);for(g=0;g<q.children.length;++g)if(a=q.children[g],a.grid)a.visible=d&&e(a.grid,3);else if(a.zid)a.visible=e(a.zid,
2);else if(a.xyid)a.visible=e(a.xyid,3);else if(a.xyboxid){b=5;var u=0;d&&!c?(b=3,u=-2):c&&!d?b=3:c||d||(b=a.bottom?3:0);a.visible=e(a.xyboxid+u,b);!a.visible&&a.bottom&&d&&(a.visible=e(a.xyboxid,3))}else a.zboxid&&(b=2,u=0,c&&d?b=5:d&&!c?b=4:!d&&c&&(u=-2,b=4),a.visible=e(a.zboxid+u,b))}else b.remove(q)};e.TFramePainter.prototype.Set3DOptions=function(a){this.opt3d=a};e.TFramePainter.prototype.DrawXYZ=function(a,b){function c(a,b,d){var c=new g.Geometry;"z"===a?c.vertices.push(new g.Vector3(0,0,0),
new g.Vector3(4*A,0,0),new g.Vector3(4*A,0,2*b),new g.Vector3(0,0,2*b)):c.vertices.push(new g.Vector3(-b,0,0),new g.Vector3(b,0,0),new g.Vector3(b,4*-A,0),new g.Vector3(-b,4*-A,0));c.faces.push(new g.Face3(0,2,1));c.faces.push(new g.Face3(0,3,2));c.computeFaceNormals();var f=new g.MeshBasicMaterial({transparent:!0,vertexColors:g.NoColors,side:g.DoubleSide,opacity:0});c=new g.Mesh(c,f);c.zoom=a;c.size_3d=b;c.use_y_for_z=d;"y"==a&&c.rotateZ(Math.PI/2).rotateX(Math.PI);c.GlobalIntersect=function(a){var b=
new g.Plane,c=this.geometry;if(c&&c.vertices&&(b.setFromCoplanarPoints(c.vertices[0],c.vertices[1],c.vertices[2]),b.applyMatrix4(this.matrixWorld),c=a.ray.origin.clone(),a=c.clone().addScaledVector(a.ray.direction,1E10),b=b.intersectLine(new g.Line3(c,a),new g.Vector3)))return a=-this.size_3d,c=this.size_3d,"z"===this.zoom&&(a=0,c=2*this.size_3d),b[this.zoom]<a?b[this.zoom]=a:b[this.zoom]>c&&(b[this.zoom]=c),b};c.ShowSelection=function(a,b){var c=this.children?this.children[0]:null,d=this.zoom;if(!a||
!b)return c&&(this.remove(c),e.Painter.DisposeThreejsObject(c)),c;if(c)var f=c.geometry;else f=this.geometry.clone(),"z"===d?f.vertices[1].x=f.vertices[2].x=A:f.vertices[2].y=f.vertices[3].y=-A,c=new g.Mesh(f,new g.MeshBasicMaterial({color:65280,side:g.DoubleSide})),this.add(c);"z"==d?(f.vertices[0].z=f.vertices[1].z=a[d],f.vertices[2].z=f.vertices[3].z=b[d]):(f.vertices[0].x=f.vertices[3].x=a[d],f.vertices[1].x=f.vertices[2].x=b[d]);f.computeFaceNormals();f.verticesNeedUpdate=!0;return f.normalsNeedUpdate=
!0};return c}b||(b={});var d=-this.size_xy3d,z=this.size_xy3d,w=-this.size_xy3d,q=this.size_xy3d,k=0,u=2*this.size_z3d,m=Math.round(.05*this.size_z3d),f=this.root_pad(),t=this.xmin,y=this.xmax,l=this.ymin,p=this.ymax,h=this.zmin,n=this.zmax,v=!1,r=!1;this.size_z3d||(d=this.xmin,z=this.xmax,w=this.ymin,q=this.ymax,k=this.zmin,u=this.zmax,m=.05*(u-k));"zoom_xmin"in this&&"zoom_xmax"in this&&this.zoom_xmin!==this.zoom_xmax&&(t=this.zoom_xmin,y=this.zoom_xmax);"zoom_ymin"in this&&"zoom_ymax"in this&&
this.zoom_ymin!==this.zoom_ymax&&(l=this.zoom_ymin,p=this.zoom_ymax,v=!0);"zoom_zmin"in this&&"zoom_zmax"in this&&this.zoom_zmin!==this.zoom_zmax&&(h=this.zoom_zmin,n=this.zoom_zmax,r=!0);b.use_y_for_z&&(this.zmin=this.ymin,this.zmax=this.ymax,h=l,n=p,r=v,l=0,p=1);this.lego_zmin=h;this.lego_zmax=n;void 0===b.zmult||r||(n*=b.zmult);if(f&&f.fLogx){0>=y&&(y=1);if(0>=t&&this.xaxis)for(v=0;v<this.xaxis.fNbins&&!(t=Math.max(t,this.xaxis.GetBinLowEdge(v+1)),0<t);++v);0>=t&&(t=1E-4*y);this.grx=K.scaleLog();
this.x_kind="log"}else this.grx=K.scaleLinear(),this.x_kind=this.xaxis&&this.xaxis.fLabels?"labels":"normal";this.logx="log"===this.x_kind;this.grx.domain([t,y]).range([d,z]);this.x_handle=new e.TAxisPainter(this.xaxis);this.x_handle.SetAxisConfig("xaxis",this.x_kind,this.grx,this.xmin,this.xmax,t,y);this.x_handle.CreateFormatFuncs();this.scale_xmin=t;this.scale_xmax=y;if(f&&f.fLogy&&!b.use_y_for_z){0>=p&&(p=1);if(0>=l&&this.yaxis)for(v=0;v<this.yaxis.fNbins&&!(l=Math.max(l,this.yaxis.GetBinLowEdge(v+
1)),0<l);++v);0>=l&&(l=1E-4*p);this.gry=K.scaleLog();this.y_kind="log"}else this.gry=K.scaleLinear(),this.y_kind=this.yaxis&&this.yaxis.fLabels?"labels":"normal";this.logy="log"===this.y_kind;this.gry.domain([l,p]).range([w,q]);this.y_handle=new e.TAxisPainter(this.yaxis);this.y_handle.SetAxisConfig("yaxis",this.y_kind,this.gry,this.ymin,this.ymax,l,p);this.y_handle.CreateFormatFuncs();this.scale_ymin=l;this.scale_ymax=p;f&&f.fLogz?(0>=n&&(n=1),0>=h&&(h=1E-4*n),this.grz=K.scaleLog(),this.z_kind="log"):
(this.grz=K.scaleLinear(),this.z_kind="normal",this.zaxis&&this.zaxis.fLabels&&3===b.ndim&&(this.z_kind="labels"));this.logz="log"===this.z_kind;this.grz.domain([h,n]).range([k,u]);this.SetRootPadRange(f,!0);this.z_handle=new e.TAxisPainter(this.zaxis);this.z_handle.SetAxisConfig("zaxis",this.z_kind,this.grz,this.zmin,this.zmax,h,n);this.z_handle.CreateFormatFuncs();this.scale_zmin=h;this.scale_zmax=n;this.x_handle.debug=!0;var D=new g.MeshBasicMaterial({color:0});f=new g.LineBasicMaterial({color:0});
var A=.5*m;y=[];var B=1;r=this.x_handle.CreateTicks(!1,!0);v=this.y_handle.CreateTicks(!1,!0);l=this.z_handle.CreateTicks(!1,!0);t=new g.Object3D;t.axis_draw=!0;a.add(t);a=[];for(var O=0,J=this.xaxis;r.next();){var H=r.grpos;h=1===r.kind;p=this.x_handle.format(r.tick,!0,!0);r.last_major()?J&&J.fTitle||(p="x"):null===p&&(h=!1,p="");if(h&&p&&0<p.length){p=new g.TextGeometry(p,{font:e.threejs_font_helvetiker_regular,size:m,height:0,curveSegments:5});p.computeBoundingBox();n=p.boundingBox.max.x-p.boundingBox.min.x;
var G=p.boundingBox.max.y-p.boundingBox.min.y;p.center=!0;O=Math.max(O,G);p.grx=H;y.push(p);r.last_major()||(G=r.next_major_grpos()-H,0<n&&(B=Math.min(B,.9*G/n)),this.x_handle.IsCenterLabels()&&(p.grx+=G/2))}a.push(H,0,0,H,h?-A:.6*-A,0)}J&&J.fTitle&&(p=new g.TextGeometry(J.fTitle,{font:e.threejs_font_helvetiker_regular,size:m,height:0,curveSegments:5}),p.computeBoundingBox(),p.center=J.TestBit(e.EAxisBits.kCenterTitle),p.gry=2,p.grx=(d+z)/2,y.push(p));this.Get3DZoomCoord=function(a,b){a=a[b];var c=
this["scale_"+b+"min"],d=this["scale_"+b+"max"];a="z"===b?a/2/this.size_z3d:(a+this.size_xy3d)/2/this.size_xy3d;return a=this["log"+b]?Math.exp(Math.log(c)+a*(Math.log(d)-Math.log(c))):c+a*(d-c)};var E=new g.Object3D;E.position.set(0,w,k);E.rotation.x=.25*Math.PI;E.xyid=2;a=e.Painter.createLineSegments(a,f);E.add(a);y.forEach(function(a){var b=a.boundingBox.max.x-a.boundingBox.min.x,c=a.center?a.grx-b/2:z-b;b=new g.Matrix4;b.set(B,0,0,c,0,B,0,(-O*B-1.5*A)*(a.gry||1),0,0,1,0,0,0,0,1);a=new g.Mesh(a,
D);a.applyMatrix(b);E.add(a)});b.zoom&&E.add(c("x",this.size_xy3d));t.add(E);E=new g.Object3D;E.position.set(0,q,k);E.rotation.x=.75*Math.PI;E.add(new g.LineSegments(a.geometry,f));y.forEach(function(a){var b=a.boundingBox.max.x-a.boundingBox.min.x,c=a.center?a.grx+b/2:z;b=new g.Matrix4;b.set(-B,0,0,c,0,B,0,(-O*B-1.5*A)*(a.gry||1),0,0,-1,0,0,0,0,1);a=new g.Mesh(a,D);a.applyMatrix(b);E.add(a)});E.xyid=4;b.zoom&&E.add(c("x",this.size_xy3d));t.add(E);y=[];B=1;O=0;a=[];for(r=this.yaxis;v.next();)J=v.grpos,
h=1===v.kind,p=this.y_handle.format(v.tick,!0,!0),v.last_major()?r&&r.fTitle||(p="y"):null===p&&(h=!1,p=""),h&&(p=new g.TextGeometry(p,{font:e.threejs_font_helvetiker_regular,size:m,height:0,curveSegments:5}),p.computeBoundingBox(),n=p.boundingBox.max.x-p.boundingBox.min.x,G=p.boundingBox.max.y-p.boundingBox.min.y,p.center=!0,O=Math.max(O,G),p.gry=J,y.push(p),v.last_major()||(G=v.next_major_grpos()-J,0<n&&(B=Math.min(B,.9*G/n)),this.y_handle.IsCenterLabels()&&(p.gry+=G/2))),a.push(0,J,0,h?-A:.6*-A,
J,0);r&&r.fTitle&&(p=new g.TextGeometry(r.fTitle,{font:e.threejs_font_helvetiker_regular,size:m,height:0,curveSegments:5}),p.computeBoundingBox(),p.center=r.TestBit(e.EAxisBits.kCenterTitle),p.grx=2,p.gry=(w+q)/2,y.push(p));if(!b.use_y_for_z){a=e.Painter.createLineSegments(a,f);var F=new g.Object3D;F.position.set(d,0,k);F.rotation.y=-.25*Math.PI;F.add(a);y.forEach(function(a){var b=a.boundingBox.max.x-a.boundingBox.min.x,c=a.center?a.gry+b/2:q;b=new g.Matrix4;b.set(0,B,0,(-O*B-1.5*A)*(a.grx||1),-B,
0,0,c,0,0,1,0,0,0,0,1);a=new g.Mesh(a,D);a.applyMatrix(b);F.add(a)});F.xyid=3;b.zoom&&F.add(c("y",this.size_xy3d));t.add(F);F=new g.Object3D;F.position.set(z,0,k);F.rotation.y=-.75*Math.PI;F.add(new g.LineSegments(a.geometry,f));y.forEach(function(a){var b=a.boundingBox.max.x-a.boundingBox.min.x,c=a.center?a.gry-b/2:q-b;b=new g.Matrix4;b.set(0,B,0,(-O*B-1.5*A)*(a.grx||1),B,0,0,c,0,0,-1,0,0,0,0,1);a=new g.Mesh(a,D);a.applyMatrix(b);F.add(a)});F.xyid=1;b.zoom&&F.add(c("y",this.size_xy3d));t.add(F)}y=
[];B=1;a=[];var L=J=H=null;v=this.zaxis;r=0;this.size_z3d&&(H=[],J=[]);for(;l.next();){var I=l.grpos;h=1==l.kind;p=this.z_handle.format(l.tick,!0,!0);null===p&&(h=!1,p="");h&&p&&(p=new g.TextGeometry(p,{font:e.threejs_font_helvetiker_regular,size:m,height:0,curveSegments:5}),p.computeBoundingBox(),n=p.boundingBox.max.x-p.boundingBox.min.x,G=p.boundingBox.max.y-p.boundingBox.min.y,p.translate(-n,-G/2,0),p.grz=I,y.push(p),null!==L&&0<G&&(B=Math.min(B,.9*(I-L)/G)),r=Math.max(r,n),L=I);H&&h&&H.push(d,
0,I,z,0,I);J&&h&&J.push(0,w,I,0,q,I);a.push(0,0,I,h?A:.6*A,0,I)}H&&0<H.length&&(l=new g.LineDashedMaterial({color:0,dashSize:2,gapSize:2}),p=e.Painter.createLineSegments(H,l),p.position.set(0,q,0),p.grid=2,p.visible=!1,t.add(p),l=new g.LineSegments(p.geometry,l),l.position.set(0,w,0),l.grid=4,l.visible=!1,t.add(l));J&&0<J.length&&(l=new g.LineDashedMaterial({color:0,dashSize:2,gapSize:2}),p=e.Painter.createLineSegments(J,l),p.position.set(z,0,0),p.grid=3,p.visible=!1,t.add(p),l=new g.LineSegments(p.geometry,
l),l.position.set(d,0,0),l.grid=1,l.visible=!1,t.add(l));var C=[];l=e.Painter.createLineSegments(a,f);for(var x=0;4>x;++x)C.push(new g.Object3D),y.forEach(function(a){var b=new g.Matrix4;b.set(-B,0,0,2*A,0,0,1,0,0,B,0,a.grz);a=new g.Mesh(a,D);a.applyMatrix(b);C[x].add(a)}),v&&v.fTitle&&(p=new g.TextGeometry(v.fTitle,{font:e.threejs_font_helvetiker_regular,size:m,height:0,curveSegments:5}),p.computeBoundingBox(),n=p.boundingBox.max.x-p.boundingBox.min.x,G=p.boundingBox.max.y-p.boundingBox.min.y,h=
v.TestBit(e.EAxisBits.kCenterTitle)?(u+k-n)/2:u-n,p.rotateZ(Math.PI/2),a=new g.Matrix4,a.set(-B,0,0,3*A+r,0,0,1,0,0,B,0,h),p=new g.Mesh(p,D),p.applyMatrix(a),C[x].add(p)),C[x].add(0==x?l:new g.LineSegments(l.geometry,f)),b.zoom&&C[x].add(c("z",this.size_z3d,b.use_y_for_z)),C[x].zid=x+2,t.add(C[x]);C[0].position.set(d,q,0);C[0].rotation.z=.75*Math.PI;C[1].position.set(z,q,0);C[1].rotation.z=.25*Math.PI;C[2].position.set(z,w,0);C[2].rotation.z=-.25*Math.PI;C[3].position.set(d,w,0);C[3].rotation.z=-.75*
Math.PI;if(0!==this.size_z3d){m=e.Painter.createLineSegments([d,0,0,z,0,0],f,null,!0);for(x=0;2>x;++x)b=new g.LineSegments(m,f),b.position.set(0,w,0===x?k:u),b.xyboxid=2,b.bottom=0==x,t.add(b),b=new g.LineSegments(m,f),b.position.set(0,q,0===x?k:u),b.xyboxid=4,b.bottom=0==x,t.add(b);w=e.Painter.createLineSegments([0,w,0,0,q,0],f,null,!0);for(x=0;2>x;++x)b=new g.LineSegments(w,f),b.position.set(d,0,0===x?k:u),b.xyboxid=3,b.bottom=0==x,t.add(b),b=new g.LineSegments(w,f),b.position.set(z,0,0===x?k:u),
b.xyboxid=1,b.bottom=0==x,t.add(b);d=e.Painter.createLineSegments([0,0,k,0,0,u],f,null,!0);for(x=0;4>x;++x)b=new g.LineSegments(d,f),b.zboxid=C[x].zid,b.position.copy(C[x].position),t.add(b)}};e.THistPainter.prototype.Draw3DBins=function(){function a(a,b,c){r=B.getBinContent(a+1,b+1);v=O?O.getBinContent(a+1,b+1):!1!==A.options.BaseLine?A.options.BaseLine:A.options.Zero?u:0;r<v&&(a=v,v=r,r=a);if(v>=I||r<L)return!1;D=r===L||v>=r;return!D||0<c?!0:B.$baseh?!1:A.options.Zero||0<u?!0:A._show_empty_bins}
if(this.draw_content){if(this.IsTH2Poly()&&this.DrawPolyLego)return this.DrawPolyLego();if(2==this.Dimension()&&this.options.Contour&&this.DrawContour3D)return this.DrawContour3D(!0);if(2==this.Dimension()&&this.options.Surf&&this.DrawSurf)return this.DrawSurf();if(2==this.Dimension()&&this.options.Error&&this.DrawError)return this.DrawError();var b=e.Painter.Box3D.Vertices,c=e.Painter.Box3D.Indexes,d=e.Painter.Box3D.Normals,z=e.Painter.Box3D.Segments,w=[0,1,1,2,2,3,3,0],q=[new g.Vector3(0,0,0),new g.Vector3(0,
1,0),new g.Vector3(1,1,0),new g.Vector3(1,0,0)],k=this.frame_painter(),u=k.grz.domain()[0],m=k.grz.domain()[1],f=this.PrepareColorDraw({rounding:!1,use3d:!0,extra:1}),t=f.i1,y=f.i2,l=f.j1,p=f.j2,h,n,v,r,D,A=this,B=this.GetHisto(),O=B?B.$baseh:null,J=11===this.options.Lego||13===this.options.Lego;if(!(t>=y||l>=p)){var H=65535>B.getBin(y,p),G=[u,m],E=null;if(12===this.options.Lego||14===this.options.Lego)G=this.CreateContour(B.fContour?B.fContour.length:20,k.lego_zmin,k.lego_zmax),E=this.GetPalette();
for(var F=0;F<G.length-1;++F){var L=G[F],I=G[F+1],C=0,x=0,Y=0,M=0;E&&F==G.length-2&&I<m&&(I=m);var R=k.grz(L),V=k.grz(I);for(h=t;h<y;++h)for(n=l;n<p;++n)if(a(h,n,F)){var N=!D&&0<F;var Q=!D&&r>I&&F<G.length-2;Y+=D?12:c.length;N&&(Y-=6);Q&&(Y-=6);J&&!D&&(Y-=12,M+=12)}var Z=new Float32Array(3*Y),S=new Float32Array(3*Y),U=H?new Uint16Array(Y/3):new Uint32Array(Y/3),P=null,W=null;Y=null;var ba=0,ca=0,aa;0<M&&(P=new Float32Array(3*M),W=new Float32Array(3*M),Y=H?new Uint16Array(M/3):new Uint32Array(M/3));
for(h=t;h<y;++h){var da=f.grx[h]+f.xbar1*(f.grx[h+1]-f.grx[h]);var ha=f.grx[h]+f.xbar2*(f.grx[h+1]-f.grx[h]);for(n=l;n<p;++n)if(a(h,n,F)){N=!D&&0<F;Q=!D&&r>I&&F<G.length-2;var ea=f.gry[n]+f.ybar1*(f.gry[n+1]-f.gry[n]);var ia=f.gry[n]+f.ybar2*(f.gry[n+1]-f.gry[n]);C=v<=L?R:k.grz(v);x=r>I?V:k.grz(r);var T=aa=0;D&&(aa+=12,T+=24);var ka=c.length,la=B.getBin(h+1,n+1);for(N&&(ka-=6);T<ka;)N=b[c[T]],J&&12>T?(P[ca]=da+N.x*(ha-da),P[ca+1]=ea+N.y*(ia-ea),P[ca+2]=C+N.z*(x-C),W[ca]=d[aa],W[ca+1]=d[aa+1],W[ca+
2]=d[aa+2],0===ca%9&&(Y[ca/9]=la),ca+=3):(Z[ba]=da+N.x*(ha-da),Z[ba+1]=ea+N.y*(ia-ea),Z[ba+2]=C+N.z*(x-C),S[ba]=d[aa],S[ba+1]=d[aa+1],S[ba+2]=d[aa+2],0===ba%9&&(U[ba/9]=la),ba+=3),++T,0===T%6&&(aa+=3,Q&&T===c.length-12&&(T+=6,aa+=3))}}n=new g.BufferGeometry;n.addAttribute("position",new g.BufferAttribute(Z,3));n.addAttribute("normal",new g.BufferAttribute(S,3));R=B.fFillColor;V=this.get_color(R);if(E)V=E.calcColor(F,G.length);else if(1===this.options.Lego||2>R)R=1,V="white";h=new g.MeshBasicMaterial({color:V,
flatShading:!0});h=new g.Mesh(n,h);h.face_to_bins_index=U;h.painter=this;h.zmin=u;h.zmax=m;h.baseline=!1!==this.options.BaseLine?this.options.BaseLine:this.options.Zero?u:0;h.tip_color=3===R?16711680:65280;h.handle=f;h.tooltip=function(a){if(isNaN(a.faceIndex))return console.error("faceIndex not provided, check three.js version",g.REVISION,"expected r97"),null;if(0>a.faceIndex||a.faceIndex>=this.face_to_bins_index.length)return null;var b=this.painter,c=this.handle,d=b.frame_painter(),f=b.GetHisto();
a=b.Get3DToolTip(this.face_to_bins_index[a.faceIndex]);a.x1=Math.max(-d.size_xy3d,c.grx[a.ix-1]+c.xbar1*(c.grx[a.ix]-c.grx[a.ix-1]));a.x2=Math.min(d.size_xy3d,c.grx[a.ix-1]+c.xbar2*(c.grx[a.ix]-c.grx[a.ix-1]));a.y1=Math.max(-d.size_xy3d,c.gry[a.iy-1]+c.ybar1*(c.gry[a.iy]-c.gry[a.iy-1]));a.y2=Math.min(d.size_xy3d,c.gry[a.iy-1]+c.ybar2*(c.gry[a.iy]-c.gry[a.iy-1]));c=this.baseline;var e=a.value;f.$baseh&&(c=f.$baseh.getBinContent(a.ix,a.iy));e<c&&(f=c,c=e,e=f);a.z1=d.grz(Math.max(this.zmin,c));a.z2=
d.grz(Math.min(this.zmax,e));a.color=this.tip_color;b.is_projection&&2==b.Dimension()&&(a.$painter=b);return a};k.toplevel.add(h);0<M&&(n=new g.BufferGeometry,n.addAttribute("position",new g.BufferAttribute(P,3)),n.addAttribute("normal",new g.BufferAttribute(W,3)),R=2>R?new g.Color(16711680):new g.Color(K.rgb(V).darker(.5).toString()),R=new g.MeshBasicMaterial({color:R,flatShading:!0}),n=new g.Mesh(n,R),n.face_to_bins_index=Y,n.painter=this,n.handle=h.handle,n.tooltip=h.tooltip,n.zmin=h.zmin,n.zmax=
h.zmax,n.baseline=h.baseline,n.tip_color=h.tip_color,k.toplevel.add(n))}if(!(12<this.options.Lego)){J=d=0;c=!0;H=0;I=m;L=u;for(h=t;h<y;++h)for(n=l;n<p;++n)a(h,n,0)?(d+=D?q.length:b.length,J+=D?w.length:z.length):H++;65520<d&&(c=!1);c||(d=3*J);d=new Float32Array(3*d);J=c?new Uint16Array(J):null;R=k.grz(u);V=k.grz(m);G=H=x=C=0;for(h=t;h<y;++h)for(da=f.grx[h]+f.xbar1*(f.grx[h+1]-f.grx[h]),ha=f.grx[h]+f.xbar2*(f.grx[h+1]-f.grx[h]),n=l;n<p;++n)if(a(h,n,0))if(ea=f.gry[n]+f.ybar1*(f.gry[n+1]-f.gry[n]),ia=
f.gry[n]+f.ybar2*(f.gry[n+1]-f.gry[n]),C=v<=u?R:k.grz(v),x=r>m?V:k.grz(r),t=D?w:z,E=D?q:b,c){for(T=0;T<t.length;++T)J[G++]=H/3+t[T];for(T=0;T<E.length;++T)N=E[T],d[H]=da+N.x*(ha-da),d[H+1]=ea+N.y*(ia-ea),d[H+2]=C+N.z*(x-C),H+=3}else for(T=0;T<t.length;++T)N=E[t[T]],d[H]=da+N.x*(ha-da),d[H+1]=ea+N.y*(ia-ea),d[H+2]=C+N.z*(x-C),H+=3;b=this.get_color(B.fLineColor);h=new g.LineBasicMaterial({color:new g.Color(b)});e.browser.isIE||(h.linewidth=B.fLineWidth);b=e.Painter.createLineSegments(d,h,c?J:null);
k.toplevel.add(b)}}}};e.Painter.drawAxis3D=function(a,b,c){c=new e.TObjectPainter(b);"_main"in b||c.SetDivId(a);c.Draw3DAxis=function(){var a=this.frame_painter();if(!a||!a._toplevel)return console.warn("no geo object found for 3D axis drawing");var b=(new g.Box3).setFromObject(a._toplevel);this.xmin=b.min.x;this.xmax=b.max.x;this.ymin=b.min.y;this.ymax=b.max.y;this.zmin=b.min.z;this.zmax=b.max.z;this.size_xy3d=this.size_z3d=0;this.DrawXYZ=e.TFramePainter.prototype.DrawXYZ;this.DrawXYZ(a._toplevel);
a.adjustCameraPosition();a.Render3D()};c.Draw3DAxis();return c.DrawingReady()};e.TH1Painter.prototype.Draw3D=function(a,b){this.mode3d=!0;var c=this.frame_painter(),d=this.is_main_painter(),g=this.GetHisto();b?d&&c.Resize3D()&&c.Render3D():(this.DeleteAtt(),this.ScanContent(!0),d&&(c.Create3DScene(),c.SetAxesRanges(g.fXaxis,this.xmin,this.xmax,g.fYaxis,this.ymin,this.ymax,g.fZaxis,0,0),c.Set3DOptions(this.options),c.DrawXYZ(c.toplevel,{use_y_for_z:!0,zmult:1.1,zoom:e.gStyle.Zooming,ndim:1})),c.mode3d&&
(this.Draw3DBins(),c.Render3D(),this.UpdateStatWebCanvas(),c.AddKeysHandler()));d&&(this.DrawColorPalette(this.options.Zscale&&(12===this.options.Lego||14===this.options.Lego)),this.DrawTitle());e.CallBack(a)};e.TH2Painter.prototype.Draw3D=function(a,b){this.mode3d=!0;var c=this.frame_painter(),d=this.is_main_painter(),g=this.GetHisto();if(b)d&&c.Resize3D()&&c.Render3D();else{b=this.root_pad();var w=1.1;this.zmin=b.fLogz?.3*this.gminposbin:this.gminbin;this.zmax=this.gmaxbin;-1111!==this.options.minimum&&
(this.zmin=this.options.minimum);-1111!==this.options.maximum&&(this.zmax=this.options.maximum,w=1);b.fLogz&&0>=this.zmin&&(this.zmin=1E-5*this.zmax);this.DeleteAtt();d&&(c.Create3DScene(),c.SetAxesRanges(g.fXaxis,this.xmin,this.xmax,g.fYaxis,this.ymin,this.ymax,g.fZaxis,this.zmin,this.zmax),c.Set3DOptions(this.options),c.DrawXYZ(c.toplevel,{zmult:w,zoom:e.gStyle.Zooming,ndim:2}));c.mode3d&&(this.Draw3DBins(),c.Render3D(),this.UpdateStatWebCanvas(),c.AddKeysHandler())}d&&(this.DrawColorPalette(this.options.Zscale&&
(12===this.options.Lego||14===this.options.Lego||11===this.options.Surf||12===this.options.Surf)),this.DrawTitle());e.CallBack(a)};e.TH2Painter.prototype.DrawContour3D=function(a){var b=this.frame_painter(),c=this.PrepareColorDraw({rounding:!1,use3d:!0,extra:100,middle:0}),d=this.GetHisto(),g=this.GetContour(),w=this.GetPalette(),q=2*b.size_z3d,k=[];this.BuildContour(c,g,w,function(c,d,f,e,z,l){if(!(3>z-e)){if(a&&(q=b.grz(g[l]),0>q||q>2*b.size_z3d))return;for(c=e;c<z;++c)k.push(d[c],f[c],q),k.push(d[c+
1],f[c+1],q)}});c=e.Painter.createLineSegments(k,e.Painter.Create3DLineMaterial(this,d));b.toplevel.add(c)};e.TH2Painter.prototype.DrawSurf=function(){function a(a,b,c,d,f,e){if(h){var k=0>c?-1:c>2*q.size_z3d?1:0,l=0>e?-1:e>2*q.size_z3d?1:0;if(k!==l||0===k){if(!D)return++J;if(0!==k){var g=e-c;c=0>k?0:2*q.size_z3d;a=d-(d-a)/g*(e-c);b=f-(f-b)/g*(e-c)}0!==l&&(g=c-e,e=0>l?0:2*q.size_z3d,d=a-(a-d)/g*(c-e),f=b-(b-f)/g*(c-e));H[G]=a;H[G+1]=b;H[G+2]=c;G+=3;H[G]=d;H[G+1]=f;H[G+2]=e;G+=3}}}function b(a,b,c,
d,f,e,k,h){x>=C.length&&console.log("more than 6 points???");c=(k-c)/(e-c);e=3;0!==K&&Math.abs(c)<Math.abs(K)&&(C[x]=C[x-3],C[x+1]=C[x-2],C[x+2]=C[x-1],x-=3,e=6);C[x]=a+c*(d-a);C[x+1]=b+c*(f-b);C[x+2]=k;h&&F&&(M[R]=C[x],M[R+1]=C[x+1],M[R+2]=C[x+2],R+=3);x+=e;K=c}function c(a,b,c){b=8*((b-k.i1)*(k.j2-k.j1)+(c-k.j1));if(0<=I[b])return console.error("More than 8 vertexes for the bin");c=b+8+I[b];I[b]--;I[c]=a}function d(a){for(var b=k.i1;b<k.i2;++b)for(var c=k.j1;c<k.j2;++c){var d=8*((b-k.i1)*(k.j2-
k.j1)+(c-k.j1));if(-1!==I[d]){var f=0<=I[d]?d:d+9+I[d];d+=8;for(var e=0,h=0,l=0,g=f;g<d;++g){var m=I[g];if(0>m)return console.error("FAILURE in NORMALS RECALCULATIONS");e+=a[m];h+=a[m+1];l+=a[m+2]}e/=d-f;h/=d-f;l/=d-f;for(g=f;g<d;++g)m=I[g],a[m]=e,a[m+1]=h,a[m+2]=l}}}function z(a,d,f,e,h,k,l,g,n,t){for(var q=1;q<p.length;++q){var z=f<p[q-1]?-1:f>p[q]?1:0,r=k<p[q-1]?-1:k>p[q]?1:0,w=n<p[q-1]?-1:n>p[q]?1:0,y=z+r+w;if(3!==y){if(-3===y)break;if(D){if(x=R=0,0===z&&(C[x]=a,C[x+1]=d,C[x+2]=f,x+=3),z!==r&&
(K=0,(0>z||0>r)&&b(a,d,f,e,h,k,p[q-1]),(0<z||0<r)&&b(a,d,f,e,h,k,p[q],!0)),0===r&&(C[x]=e,C[x+1]=h,C[x+2]=k,x+=3),r!==w&&(K=0,(0>r||0>w)&&b(e,h,k,l,g,n,p[q-1]),(0<r||0<w)&&b(e,h,k,l,g,n,p[q],!0)),0===w&&(C[x]=l,C[x+1]=g,C[x+2]=n,x+=3),w!==z&&(K=0,(0>w||0>z)&&b(l,g,n,a,d,f,p[q-1]),(0<w||0<z)&&b(l,g,n,a,d,f,p[q],!0)),0!==x)if(9>x)console.log("found less than 3 points",x/3);else{if(F&&6===R){for(z=0;6>z;++z)F[L+z]=M[z];L+=6}z=B[q];r=O[q];v&&9===x&&(c(r,u,m),c(r+3,u+1,t?m+1:m),c(r+6,t?u:u+1,m+1));for(w=
3;w<x-3;w+=3)z[r]=C[0],z[r+1]=C[1],z[r+2]=C[2],r+=3,z[r]=C[w],z[r+1]=C[w+1],z[r+2]=C[w+2],r+=3,z[r]=C[w+3],z[r+1]=C[w+4],z[r+2]=C[w+5],r+=3;O[q]=r}}else y=Math.abs(r-z)+Math.abs(w-r)+Math.abs(z-w),0===z&&++y,0===r&&++y,0===w&&++y,1!==y&&2!==y||console.error("FOND npnts",y),2<y&&(void 0===A[q]&&(A[q]=0),A[q]+=y-2),!(0<z||0<r||0<w)||z===r&&r===w&&w===z||++E}}}var w=this.GetHisto(),q=this.frame_painter(),k=this.PrepareColorDraw({rounding:!1,use3d:!0,extra:1,middle:.5}),u,m,f,t,y=q.grz.domain()[0];q.grz.domain();
var l=q.logz?function(a){return a<y?-.1:q.grz(a)}:q.grz;if(!(2>k.i2-k.i1||2>k.j2-k.j1)){var p=f=null,h=!0,n=!1,v=!1,r=null;switch(this.options.Surf){case 11:f=this.GetContour();r=this.GetPalette();break;case 12:case 15:case 17:f=this.GetContour();r=this.GetPalette();h=!1;break;case 14:h=!1;v=!0;break;case 16:f=this.GetContour();n=!0;h=!1;break;default:f=q.z_handle.CreateTicks(!0),n=!0}if(f)for(p=new Float32Array(f.length),t=0;t<f.length;++t)p[t]=l(f[t]);else p=[0,2*q.size_z3d];var D,A=[],B=[],O=[],
J=0,H=null,G=0,E=0,F=null,L=0,I=null,C=new Float32Array(18),x=0,K=0,M=new Float32Array(6),R=0;if(v)for(I=new Int32Array((k.i2-k.i1)*(k.j2-k.j1)*8),f=0;f<I.length;++f)I[f]=-1;for(D=0;2>D;++D){if(D){for(f=1;f<p.length;++f)A[f]&&(B[f]=new Float32Array(9*A[f]),O[f]=0);h&&0<J&&(H=new Float32Array(6*J));n&&0<E&&(F=new Float32Array(6*E))}for(u=k.i1;u<k.i2-1;++u){f=k.grx[u];var V=k.grx[u+1];for(m=k.j1;m<k.j2-1;++m){t=k.gry[m];var N=k.gry[m+1];var Q=l(w.getBinContent(u+1,m+1));var Z=l(w.getBinContent(u+1,
m+2));var S=l(w.getBinContent(u+2,m+1));var U=l(w.getBinContent(u+2,m+2));z(f,t,Q,V,N,U,f,N,Z,!0);z(f,t,Q,V,t,S,V,N,U,!1);a(f,N,Z,f,t,Q);a(f,t,Q,V,t,S);u===k.i2-2&&a(V,t,S,V,N,U);m===k.j2-2&&a(f,N,Z,V,N,U)}}}for(f=1;f<p.length;++f)B[f]&&(O[f]!==9*A[f]&&console.error("SURF faces missmatch lvl",f,"faces",A[f],"index",O[f],"check",9*A[f]-O[f]),l=new g.BufferGeometry,l.addAttribute("position",new g.BufferAttribute(B[f],3)),l.computeVertexNormals(),v&&1===f&&d(l.getAttribute("normal").array),r?n=r.calcColor(f,
p.length):(n=1<w.fFillColor?this.get_color(w.fFillColor):"white",14===this.options.Surf&&2>w.fFillColor&&(n=this.get_color(48))),n=14===this.options.Surf?new g.MeshLambertMaterial({color:n,side:g.DoubleSide}):new g.MeshBasicMaterial({color:n,side:g.DoubleSide}),l=new g.Mesh(l,n),q.toplevel.add(l),l.painter=this);H&&(6*J!==G&&console.error("SURF lines mismmatch nsegm",J," lindx",G,"difference",6*J-G),l=this.get_color(w.fLineColor),n=new g.LineBasicMaterial({color:new g.Color(l)}),e.browser.isIE||(n.linewidth=
w.fLineWidth),l=e.Painter.createLineSegments(H,n),l.painter=this,q.toplevel.add(l));F&&(6*E!==L&&console.error("SURF grid draw mismatch ngridsegm",E,"gindx",L,"diff",6*E-L),n=1===this.options.Surf?new g.LineDashedMaterial({color:0,dashSize:2,gapSize:2}):new g.LineBasicMaterial({color:new g.Color(this.get_color(w.fLineColor))}),l=e.Painter.createLineSegments(F,n),l.painter=this,q.toplevel.add(l));17===this.options.Surf&&this.DrawContour3D();if(13===this.options.Surf){k=this.PrepareColorDraw({rounding:!1,
use3d:!0,extra:100,middle:0});p=this.GetContour();r=this.GetPalette();var P=-1,W=2*q.size_z3d;this.BuildContour(k,p,r,function(a,b,c,d,f){b[f]===b[d]&&c[f]===c[d]&&f--;if(!(3>f-d)){for(var e=[],h=d;h<=f;++h)h!==d&&b[h]===b[h-1]&&c[h]===c[h-1]||e.push(new g.Vector2(b[h],c[h]));if(!(3>e.length)&&(d=g.ShapeUtils.triangulateShape(e,[]))&&0!==d.length){if(0>P||P!==a)P=a,W+=1E-4*q.size_z3d;b=new Float32Array(9*d.length);c=new Float32Array(9*d.length);for(h=f=0;h<d.length;++h)for(var k=d[h],l=0;3>l;++l){var m=
e[k[l]];b[f]=m.x;b[f+1]=m.y;b[f+2]=W;c[f]=0;c[f+1]=0;c[f+2]=1;f+=3}e=new g.BufferGeometry;e.addAttribute("position",new g.BufferAttribute(b,3));e.addAttribute("normal",new g.BufferAttribute(c,3));a=r.getColor(a);a=new g.MeshBasicMaterial({color:a,flatShading:!0,side:g.DoubleSide,opacity:.5});a=new g.Mesh(e,a);a.painter=this;q.toplevel.add(a)}}})}}};e.TH2Painter.prototype.DrawError=function(){for(var a=this.frame_painter(),b=this.GetHisto(),c=this.PrepareColorDraw({rounding:!1,use3d:!0,extra:1}),d=
a.grz.domain()[0],z=a.grz.domain()[1],w,q,k,u,m,f,t,y,l,p=0,h=null,n=null,v=0,r=0;2>r;++r){for(w=c.i1;w<c.i2;++w)for(f=c.grx[w],t=c.grx[w+1],q=c.j1;q<c.j2;++q)if(u=b.getBinContent(w+1,q+1),!(u<d||u>z)){if(m=u===d)m=this.options.Zero||0<d?!1:!this._show_empty_bins;m||(0===r?p+=3:(k=b.getBin(w+1,q+1),m=b.getBinError(k),n[v/18]=k,k=c.gry[q],y=c.gry[q+1],l=a.grz(u-m<d?d:u-m),u=a.grz(u+m>z?z:u+m),h[v]=f,h[v+3]=t,h[v+1]=h[v+4]=(k+y)/2,h[v+2]=h[v+5]=(l+u)/2,v+=6,h[v]=h[v+3]=(f+t)/2,h[v+1]=k,h[v+4]=y,h[v+
2]=h[v+5]=(l+u)/2,v+=6,h[v]=h[v+3]=(f+t)/2,h[v+1]=h[v+4]=(k+y)/2,h[v+2]=l,h[v+5]=u,v+=6))}if(0===r){if(0===p)return;h=new Float32Array(6*p);n=new Int32Array(p/3)}}b=this.get_color(this.GetObject().fLineColor);b=new g.LineBasicMaterial({color:new g.Color(b)});h=e.Painter.createLineSegments(h,b);e.browser.isIE||(b.linewidth=this.GetObject().fLineWidth);h.painter=this;h.intersect_index=n;h.zmin=d;h.zmax=z;h.tip_color=3===this.GetObject().fLineColor?16711680:65280;h.tooltip=function(a){if(isNaN(a.index))return console.error("segment index not provided, check three.js version",
g.REVISION,"expected r97"),null;var b=Math.floor(a.index/6);if(0>b||b>=this.intersect_index.length)return null;var c=this.painter;a=c.GetHisto();var d=c.frame_painter();b=c.Get3DToolTip(this.intersect_index[b]);b.x1=Math.max(-d.size_xy3d,d.grx(a.fXaxis.GetBinLowEdge(b.ix)));b.x2=Math.min(d.size_xy3d,d.grx(a.fXaxis.GetBinLowEdge(b.ix+1)));b.y1=Math.max(-d.size_xy3d,d.gry(a.fYaxis.GetBinLowEdge(b.iy)));b.y2=Math.min(d.size_xy3d,d.gry(a.fXaxis.GetBinLowEdge(b.iy+1)));b.z1=d.grz(b.value-b.error<this.zmin?
this.zmin:b.value-b.error);b.z2=d.grz(b.value+b.error>this.zmax?this.zmax:b.value+b.error);b.color=this.tip_color;return b};a.toplevel.add(h)};e.TH2Painter.prototype.DrawPolyLego=function(){var a=this.GetHisto(),b=this.frame_painter(),c=b.grz.domain()[0],d=b.grz.domain()[1],e,w=a.fBins.arr.length,q=0,k=b.grz(c),u=k;this.fContour=null;this.fCustomContour=!1;this.maxbin=this.gmaxbin;this.minbin=this.gminbin;this.minposbin=this.gminposbin;for(e=0;e<w;++e){var m=a.fBins.arr[e];if(!(m.fContent<c)){var f=
this.getContourColor(m.fContent,!0);if(null!==f&&!(m.fXmin>b.scale_xmax||m.fXmax<b.scale_xmin||m.fYmin>b.scale_ymax||m.fYmax<b.scale_ymin)){u=b.grz(m.fContent>d?d:m.fContent);var t=[],y=[],l=1,p=m.fPoly,h=0;"TMultiGraph"==p._typename&&(l=m.fPoly.fGraphs.arr.length,p=null);for(var n=0;n<l;++n){if(!p||0<n)p=m.fPoly.fGraphs.arr[n];for(var v=p.fNpoints,r=p.fX,D=p.fY;2<v&&r[0]===r[v-1]&&D[0]===D[v-1];)--v;for(var A,B,O=0;2>O;++O){var J=b.size_xy3d*b.size_z3d,H=0<O?0:J/1E6;A=[];B=null;for(var G=0;G<v;++G){var E=
b.grx(r[G]);var F=b.gry(D[G]);0<G&&(J=(E-L)*(E-L)+(F-I)*(F-I));if(J>H){A.push(new g.Vector2(E,F));var L=E;var I=F}}try{2<A.length&&(B=g.ShapeUtils.triangulateShape(A,[]))}catch(C){B=null}if(B&&B.length>A.length-3)break}B&&B.length&&A&&(t.push(A),y.push(B),h+=2*B.length,u>k&&(h+=2*A.length))}m=new Float32Array(9*h);for(n=l=0;n<t.length;++n){A=t[n];B=y[n];for(p=0;2>p;++p)for(h=0;h<B.length;++h)D=B[h],v=A[D[0]],r=A[D[0===p?2:1]],D=A[D[0===p?1:2]],m[l]=v.x,m[l+1]=v.y,m[l+2]=p?u:k,l+=3,m[l]=r.x,m[l+1]=
r.y,m[l+2]=p?u:k,l+=3,m[l]=D.x,m[l+1]=D.y,m[l+2]=p?u:k,l+=3;if(u>k)for(h=0;h<A.length;++h)v=A[h],r=A[0<h?h-1:A.length-1],m[l]=v.x,m[l+1]=v.y,m[l+2]=k,l+=3,m[l]=r.x,m[l+1]=r.y,m[l+2]=k,l+=3,m[l]=r.x,m[l+1]=r.y,m[l+2]=u,l+=3,m[l]=v.x,m[l+1]=v.y,m[l+2]=k,l+=3,m[l]=r.x,m[l+1]=r.y,m[l+2]=u,l+=3,m[l]=v.x,m[l+1]=v.y,m[l+2]=u,l+=3}t=new g.BufferGeometry;t.addAttribute("position",new g.BufferAttribute(m,3));t.computeVertexNormals();f=this.fPalette.getColor(f);f=new g.MeshBasicMaterial({color:f,flatShading:!0});
f=new g.Mesh(t,f);b.toplevel.add(f);f.painter=this;f.bins_index=e;f.draw_z0=k;f.draw_z1=u;f.tip_color=65280;f.tooltip=function(a){a=this.painter;var b=a.frame_painter(),c=a.GetObject().fBins.arr[this.bins_index];return{use_itself:!0,x1:b.grx(c.fXmin),x2:b.grx(c.fXmax),y1:b.gry(c.fYmin),y2:b.gry(c.fYmax),z1:this.draw_z0,z2:this.draw_z1,bin:this.bins_index,value:c.fContent,color:this.tip_color,lines:a.ProvidePolyBinHints(this.bins_index)}};q++}}}};Q.prototype=Object.create(e.THistPainter.prototype);
Q.prototype.ScanContent=function(a){if(!(a&&this.nbinsx&&this.nbinsy&&this.nbinsz)){a=this.GetObject();this.nbinsx=a.fXaxis.fNbins;this.nbinsy=a.fYaxis.fNbins;this.nbinsz=a.fZaxis.fNbins;this.xmin=a.fXaxis.fXmin;this.xmax=a.fXaxis.fXmax;this.ymin=a.fYaxis.fXmin;this.ymax=a.fYaxis.fXmax;this.zmin=a.fZaxis.fXmin;this.zmax=a.fZaxis.fXmax;this.gminbin=this.gmaxbin=a.getBinContent(1,1,1);for(var b=0;b<this.nbinsx;++b)for(var c=0;c<this.nbinsy;++c)for(var d=0;d<this.nbinsz;++d){var e=a.getBinContent(b+
1,c+1,d+1);e<this.gminbin?this.gminbin=e:e>this.gmaxbin&&(this.gmaxbin=e)}this.draw_content=0<this.gmaxbin;this.CreateAxisFuncs(!0,!0)}};Q.prototype.CountStat=function(){var a=this.GetHisto(),b=a.fXaxis,c=a.fYaxis,d=a.fZaxis,e=0,g=0,q=0,k=0,u=0,m=0,f=0,t=this.GetSelectIndex("x","left"),y=this.GetSelectIndex("x","right"),l=this.GetSelectIndex("y","left"),p=this.GetSelectIndex("y","right"),h=this.GetSelectIndex("z","left"),n=this.GetSelectIndex("z","right"),v=this.frame_painter(),r={name:a.fName,entries:0,
integral:0,meanx:0,meany:0,meanz:0,rmsx:0,rmsy:0,rmsz:0},D,A,B;for(D=0;D<this.nbinsx+2;++D){var O=b.GetBinCoord(D-.5);var J=D<t?0:D>y?2:1;for(A=0;A<this.nbinsy+2;++A){var H=c.GetBinCoord(A-.5);var G=A<l?0:A>p?2:1;for(B=0;B<this.nbinsz+2;++B){var E=d.GetBinCoord(B-.5);var F=B<h?0:B>n?2:1;var L=a.getBinContent(D,A,B);r.entries+=L;1==J&&1==G&&1==F&&(e+=L,g+=O*L,q+=H*L,k+=E*L,u+=O*O*L,m+=H*H*L,f+=E*E*L)}}}0<a.fTsumw&&!v.IsAxisZoomed("x")&&!v.IsAxisZoomed("y")&&!v.IsAxisZoomed("z")&&(e=a.fTsumw,g=a.fTsumwx,
u=a.fTsumwx2,q=a.fTsumwy,m=a.fTsumwy2,k=a.fTsumwz,f=a.fTsumwz2);0<e&&(r.meanx=g/e,r.meany=q/e,r.meanz=k/e,r.rmsx=Math.sqrt(Math.abs(u/e-r.meanx*r.meanx)),r.rmsy=Math.sqrt(Math.abs(m/e-r.meany*r.meany)),r.rmsz=Math.sqrt(Math.abs(f/e-r.meanz*r.meanz)));r.integral=e;1<a.fEntries&&(r.entries=a.fEntries);return r};Q.prototype.FillStatistic=function(a,b,c){if(this.IgnoreStatsFill())return!1;var d=this.CountStat(),e=b%10,g=Math.floor(b/10)%10,q=Math.floor(b/100)%10,k=Math.floor(b/1E3)%10;b=Math.floor(b/
1E6)%10;a.ClearPave();0<e&&a.AddText(d.name);0<g&&a.AddText("Entries = "+a.Format(d.entries,"entries"));0<q&&(a.AddText("Mean x = "+a.Format(d.meanx)),a.AddText("Mean y = "+a.Format(d.meany)),a.AddText("Mean z = "+a.Format(d.meanz)));0<k&&(a.AddText("Std Dev x = "+a.Format(d.rmsx)),a.AddText("Std Dev y = "+a.Format(d.rmsy)),a.AddText("Std Dev z = "+a.Format(d.rmsz)));0<b&&a.AddText("Integral = "+a.Format(d.integral,"entries"));c&&a.FillFunctionStat(this.FindFunction("TF1"),c);return!0};Q.prototype.GetBinTips=
function(a,b,c){var d=[],g=this.frame_painter(),w=this.GetHisto();d.push(this.GetTipName());"labels"==g.x_kind?d.push("x = "+g.AxisAsText("x",w.fXaxis.GetBinLowEdge(a+1))+"  xbin="+(a+1)):d.push("x = ["+g.AxisAsText("x",w.fXaxis.GetBinLowEdge(a+1))+", "+g.AxisAsText("x",w.fXaxis.GetBinLowEdge(a+2))+")   xbin="+(a+1));"labels"==g.y_kind?d.push("y = "+g.AxisAsText("y",w.fYaxis.GetBinLowEdge(b+1))+"  ybin="+(b+1)):d.push("y = ["+g.AxisAsText("y",w.fYaxis.GetBinLowEdge(b+1))+", "+g.AxisAsText("y",w.fYaxis.GetBinLowEdge(b+
2))+")  ybin="+(b+1));"labels"==g.z_kind?d.push("z = "+g.AxisAsText("z",w.fZaxis.GetBinLowEdge(c+1))+"  zbin="+(c+1)):d.push("z = ["+g.AxisAsText("z",w.fZaxis.GetBinLowEdge(c+1))+", "+g.AxisAsText("z",w.fZaxis.GetBinLowEdge(c+2))+")  zbin="+(c+1));a=w.getBinContent(a+1,b+1,c+1);a===Math.round(a)?d.push("entries = "+a):d.push("entries = "+e.FFormat(a,e.gStyle.fStatFormat));return d};Q.prototype.Draw3DScatter=function(){var a=this.GetObject(),b=this.frame_painter(),c=this.GetSelectIndex("x","left",
.5),d=this.GetSelectIndex("x","right",0),z=this.GetSelectIndex("y","left",.5),w=this.GetSelectIndex("y","right",0),q=this.GetSelectIndex("z","left",.5),k=this.GetSelectIndex("z","right",0);this.GetTipName("<br/>");var u,m,f;if(d<=c||w<=z||k<=q)return!0;var t=1E3<this.gmaxbin?1E3/this.gmaxbin:1,y=0,l=0,p=Math.max(0,this.gminbin);for(u=c;u<d;++u)for(m=z;m<w;++m)for(f=q;f<k;++f){var h=a.getBinContent(u+1,m+1,f+1);l+=h;h<=p||(y+=Math.round(h*t))}if(y>(b.webgl?1E5:3E4))return!1;e.seed(l);l=new e.Painter.PointsCreator(y,
b.webgl,b.size_xy3d/200);y=new Int32Array(y);var n=0;for(u=c;u<d;++u)for(m=z;m<w;++m)for(f=q;f<k;++f)if(h=a.getBinContent(u+1,m+1,f+1),!(h<=p))for(c=Math.round(h*t),h=0;h<c;++h){var v=a.fXaxis.GetBinCoord(u+e.random()),r=a.fYaxis.GetBinCoord(m+e.random()),D=a.fZaxis.GetBinCoord(f+e.random());y[n++]=a.getBin(u+1,m+1,f+1);l.AddPoint(b.grx(v),b.gry(r),b.grz(D))}d=l.CreatePoints(this.get_color(a.fMarkerColor));b.toplevel.add(d);d.bins=y;d.painter=this;d.tip_color=3===a.fMarkerColor?16711680:65280;d.tooltip=
function(a){if(isNaN(a.index))return console.error("intersect.index not provided, check three.js version",g.REVISION,"expected r97"),null;var b=Math.floor(a.index/this.nvertex);if(0>b||b>=this.bins.length)return null;var c=this.painter;a=c.GetHisto();var d=c.frame_painter();b=c.Get3DToolTip(this.bins[b]);b.x1=d.grx(a.fXaxis.GetBinLowEdge(b.ix));b.x2=d.grx(a.fXaxis.GetBinLowEdge(b.ix+1));b.y1=d.gry(a.fYaxis.GetBinLowEdge(b.iy));b.y2=d.gry(a.fYaxis.GetBinLowEdge(b.iy+1));b.z1=d.grz(a.fZaxis.GetBinLowEdge(b.iz));
b.z2=d.grz(a.fZaxis.GetBinLowEdge(b.iz+1));b.color=this.tip_color;b.opacity=.3;return b};return!0};Q.prototype.Draw3DBins=function(){if(this.draw_content&&(this.options.Box||this.options.GLBox||this.options.GLColor||this.options.Lego||!this.Draw3DScatter())){var a=this.GetObject().fFillColor,b=this.get_color(a),c=this.frame_painter(),d=0,z=!1,w=!1,q=!1,k=1,u=!0,m=this.options.Box?this.options.BoxStyle:0,f=.5;!m&&this.options.Lego&&(m=1===this.options.Lego?10:this.options.Lego);if(11===this.options.GLBox||
12===this.options.GLBox){f=.4;z=!0;12===this.options.GLBox&&(q=!0);m=e.Painter.TestWebGL()?new g.SphereGeometry(.5,16,12):new g.SphereGeometry(.5,8,6);m.applyMatrix((new g.Matrix4).makeRotationX(Math.PI/2));d=9*m.faces.length;var t=new Float32Array(d);var y=new Float32Array(d);for(var l=0;l<m.faces.length;++l)t[9*l]=m.vertices[m.faces[l].a].x,t[9*l+1]=m.vertices[m.faces[l].a].y,t[9*l+2]=m.vertices[m.faces[l].a].z,t[9*l+3]=m.vertices[m.faces[l].b].x,t[9*l+4]=m.vertices[m.faces[l].b].y,t[9*l+5]=m.vertices[m.faces[l].b].z,
t[9*l+6]=m.vertices[m.faces[l].c].x,t[9*l+7]=m.vertices[m.faces[l].c].y,t[9*l+8]=m.vertices[m.faces[l].c].z,y[9*l]=m.faces[l].vertexNormals[0].x,y[9*l+1]=m.faces[l].vertexNormals[0].y,y[9*l+2]=m.faces[l].vertexNormals[0].z,y[9*l+3]=m.faces[l].vertexNormals[1].x,y[9*l+4]=m.faces[l].vertexNormals[1].y,y[9*l+5]=m.faces[l].vertexNormals[1].z,y[9*l+6]=m.faces[l].vertexNormals[2].x,y[9*l+7]=m.faces[l].vertexNormals[2].y,y[9*l+8]=m.faces[l].vertexNormals[2].z}else{l=e.Painter.Box3D.Indexes;var p=e.Painter.Box3D.Normals,
h=e.Painter.Box3D.Vertices;d=3*l.length;t=new Float32Array(d);y=new Float32Array(d);for(var n=0,v=-3;n<l.length;++n){var r=h[l[n]];t[3*n]=r.x-.5;t[3*n+1]=r.y-.5;t[3*n+2]=r.z-.5;0===n%6&&(v+=3);y[3*n]=p[v];y[3*n+1]=p[v+1];y[3*n+2]=p[v+2]}w=!0;12===m?q=!0:13===m?(q=!0,w=!1):this.options.GLColor&&(q=!0,k=.5,w=u=!1,z=!0)}u&&(u=this.gminbin||this.gmaxbin?1/Math.max(Math.abs(this.gminbin),Math.abs(this.gmaxbin)):1);var D=this.GetHisto(),A=this.GetSelectIndex("x","left",.5),B=this.GetSelectIndex("x","right",
0),O=this.GetSelectIndex("y","left",.5),J=this.GetSelectIndex("y","right",0),H=this.GetSelectIndex("z","left",.5),G=this.GetSelectIndex("z","right",0);this.GetTipName("<br/>");if(!(B<=A||J<=O||G<=H)){m=(c.grx(D.fXaxis.GetBinLowEdge(B+1))-c.grx(D.fXaxis.GetBinLowEdge(A+1)))/(B-A);l=(c.gry(D.fYaxis.GetBinLowEdge(J+1))-c.gry(D.fYaxis.GetBinLowEdge(O+1)))/(J-O);p=(c.grz(D.fZaxis.GetBinLowEdge(G+1))-c.grz(D.fZaxis.GetBinLowEdge(H+1)))/(G-H);var E=0,F,L;h=[];var I=0;v=[];for(F=A;F<B;++F)for(L=O;L<J;++L)for(n=
H;n<G;++n)if(r=D.getBinContent(F+1,L+1,n+1),!(0===r||r<this.gminbin)){var C=u?Math.pow(Math.abs(r*u),.3333):1;if(!(.001>C)&&(E++,q)){var x=this.getContourColor(r,!0);null!==x?(void 0===h[x]&&(h[x]=0,v[x]=I++),h[x]+=1):console.error("not found color for",r)}}q||(h.push(E),I=1,v=[0]);var K=Array(I),M=Array(I),R=Array(I),Q=Array(I),N=Array(I),X=Array(I);I=Array(I);for(n=0;n<h.length;++n)h[n]&&(E=h[n],x=v[n],K[x]=0,N[x]=0,w&&(N[x]=65520<E*d/3?2:1),M[x]=new Float32Array(E*d),R[x]=new Float32Array(E*d),
Q[x]=new Int32Array(E),1===N[x]&&(X[x]=new Uint16Array(E*e.Painter.Box3D.MeshSegments.length)),2===N[x]&&(I[x]=new Float32Array(E*e.Painter.Box3D.Segments.length*3)));for(F=A;F<B;++F)for(n=D.fXaxis.GetBinCenter(F+1),w=c.grx(n),L=O;L<J;++L)for(n=D.fYaxis.GetBinCenter(L+1),A=c.gry(n),n=H;n<G;++n)if(r=D.getBinContent(F+1,L+1,n+1),!(0===r||r<this.gminbin||(C=u?Math.pow(Math.abs(r*u),.3333):1,.001>C))){x=0;if(q){x=this.getContourColor(r,!0);if(null===x)continue;x=v[x]}E=K[x];r=D.fZaxis.GetBinCenter(n+
1);var Z=c.grz(r);Q[x][E]=D.getBin(F+1,L+1,n+1);var S=E*d;r=M[x];for(var U=R[x],P=0;P<d;P+=3,S+=3)r[S]=w+t[P]*m*C,r[S+1]=A+t[P+1]*l*C,r[S+2]=Z+t[P+2]*p*C,U[S]=y[P],U[S+1]=y[P+1],U[S+2]=y[P+2];if(1===N[x]){U=e.Painter.Box3D.MeshSegments;S=E*U.length;r=Math.round(E*d/3);var W=X[x];for(P=0;P<U.length;++P)W[S+P]=r+U[P]}if(2===N[x])for(U=e.Painter.Box3D.Segments,W=I[x],S=E*U.length*3,P=0;P<U.length;++P,S+=3)r=e.Painter.Box3D.Vertices[U[P]],W[S]=w+(r.x-.5)*m*C,W[S+1]=A+(r.y-.5)*l*C,W[S+2]=Z+(r.z-.5)*p*
C;K[x]=E+1}for(n=0;n<h.length;++n)h[n]&&(E=h[n],x=v[n],t=new g.BufferGeometry,t.addAttribute("position",new g.BufferAttribute(M[x],3)),t.addAttribute("normal",new g.BufferAttribute(R[x],3)),q&&(b=this.fPalette.getColor(n)),y=z?new g.MeshLambertMaterial({color:b,opacity:k,transparent:1>k}):new g.MeshBasicMaterial({color:b,opacity:k}),t=new g.Mesh(t,y),t.bins=Q[x],t.bins_faces=d/9,t.painter=this,t.scalex=f*m,t.scaley=f*l,t.scalez=f*p,t.tip_color=3===a?16711680:65280,t.use_scale=u,t.tooltip=function(a){if(isNaN(a.faceIndex))return console.error("intersect.faceIndex not provided, check three.js version",
g.REVISION,"expected r97"),null;var b=Math.floor(a.faceIndex/this.bins_faces);if(0>b||b>=this.bins.length)return null;var c=this.painter;a=c.GetHisto();var d=c.frame_painter();b=c.Get3DToolTip(this.bins[b]);c=d.grx(a.fXaxis.GetBinCoord(b.ix-.5));var e=d.gry(a.fYaxis.GetBinCoord(b.iy-.5));a=d.grz(a.fZaxis.GetBinCoord(b.iz-.5));d=this.use_scale?Math.pow(Math.abs(b.value*this.use_scale),.3333):1;b.x1=c-this.scalex*d;b.x2=c+this.scalex*d;b.y1=e-this.scaley*d;b.y2=e+this.scaley*d;b.z1=a-this.scalez*d;
b.z2=a+this.scalez*d;b.color=this.tip_color;return b},c.toplevel.add(t),0<N[x]&&(t=this.get_color(this.GetObject().fLineColor),t=new g.LineBasicMaterial({color:t}),y=null,y=1===N[x]?e.Painter.createLineSegments(M[x],t,X[x]):e.Painter.createLineSegments(I[x],t),c.toplevel.add(y)))}}};Q.prototype.Redraw=function(a){var b=this.frame_painter(),c=this.GetHisto();a?b.Resize3D()&&b.Render3D():(b.Create3DScene(),b.SetAxesRanges(c.fXaxis,this.xmin,this.xmax,c.fYaxis,this.ymin,this.ymax,c.fZaxis,this.zmin,
this.zmax),b.Set3DOptions(this.options),b.DrawXYZ(b.toplevel,{zoom:e.gStyle.Zooming,ndim:3}),this.Draw3DBins(),b.Render3D(),this.UpdateStatWebCanvas(),b.AddKeysHandler());this.DrawTitle()};Q.prototype.FillToolbar=function(){var a=this.pad_painter();a&&(a.AddButton(e.ToolbarIcons.auto_zoom,"Unzoom all axes","ToggleZoom","Ctrl *"),this.draw_content&&a.AddButton(e.ToolbarIcons.statbox,"Toggle stat box","ToggleStatBox"),a.ShowButtons())};Q.prototype.CanZoomIn=function(a,b,c){var d=this.GetHisto();d&&
(d=d["f"+a.toUpperCase()+"axis"]);return!d||1<d.FindBin(c,.5)-d.FindBin(b,0)};Q.prototype.AutoZoom=function(){var a=this.GetSelectIndex("x","left"),b=this.GetSelectIndex("x","right"),c=this.GetSelectIndex("y","left"),d=this.GetSelectIndex("y","right"),e=this.GetSelectIndex("z","left"),g=this.GetSelectIndex("z","right"),q,k,u,m=this.GetObject();if(a!==b&&c!==d&&e!==g){var f=m.getBinContent(a+1,c+1,e+1);for(q=a;q<b;++q)for(k=c;k<d;++k)for(u=e;u<g;++u)f=Math.min(f,m.getBinContent(q+1,k+1,u+1));if(!(0<
f)){var t=b,y=a,l=d,p=c,h=g,n=e;for(q=a;q<b;++q)for(k=c;k<d;++k)for(u=e;u<g;++u)m.getBinContent(q+1,k+1,u+1)>f&&(q<t&&(t=q),q>=y&&(y=q+1),k<l&&(l=k),k>=p&&(p=k+1),u<h&&(h=u),u>=n&&(n=u+1));q=!1;t===y-1&&t>a+1&&y<b-1&&(t--,y++);l===p-1&&l>c+1&&p<d-1&&(l--,p++);h===n-1&&h>e+1&&n<g-1&&(h--,n++);if((t>a||y<b)&&t<y-1){var v=m.fXaxis.GetBinLowEdge(t+1);var r=m.fXaxis.GetBinLowEdge(y+1);q=!0}if((l>c||p<d)&&l<p-1){var D=m.fYaxis.GetBinLowEdge(l+1);var A=m.fYaxis.GetBinLowEdge(p+1);q=!0}if((h>e||n<g)&&h<n-
1){var B=m.fZaxis.GetBinLowEdge(h+1);var K=m.fZaxis.GetBinLowEdge(n+1);q=!0}q&&this.frame_painter().Zoom(v,r,D,A,B,K)}}};Q.prototype.FillHistContextMenu=function(a){var b=e.getDrawSettings("ROOT."+this.GetObject()._typename,"nosame");a.addDrawMenu("Draw with",b.opts,function(a){if("inspect"===a)return this.ShowInspector();this.DecodeOptions(a);this.InteractiveRedraw(!0,"drawopt")})};e.Painter.drawHistogram3D=function(a,b,c){b=new e.TH3Painter(b);b.SetDivId(a,4);b.DecodeOptions(c);b.CheckPadRange();
b.ScanContent();b.Redraw();(a=b.CreateStat())&&e.draw(b.divid,a,"");b.FillToolbar();return b.DrawingReady()};X.prototype=Object.create(e.TObjectPainter.prototype);X.prototype.DecodeOptions=function(a){var b=new e.DrawOptions(a);this.options||(this.options={});var c=this.options;c.Color=b.check("COL");c.Line=b.check("LINE");c.Error=b.check("ERR")&&this.MatchObjectType("TGraph2DErrors");c.Circles=b.check("P0");c.Markers=b.check("P");c.Markers||c.Error||c.Circles||c.Line||(c.Markers=!0);c.Markers||(c.Color=
!1);this.OptionsStore(a)};X.prototype.CreateHistogram=function(){for(var a=this.GetObject(),b=a.fX[0],c=b,d=a.fY[0],g=d,w=a.fZ[0],q=w,k=0;k<a.fNpoints;++k){var u=a.fX[k],m=a.fY[k],f=a.fZ[k],t=this.options.Error?a.fEX[k]:0,y=this.options.Error?a.fEY[k]:0,l=this.options.Error?a.fEZ[k]:0;b=Math.min(b,u-t);c=Math.max(c,u+t);d=Math.min(d,m-y);g=Math.max(g,m+y);w=Math.min(w,f-l);q=Math.max(q,f+l)}b>=c&&(c=b+1);d>=g&&(g=d+1);w>=q&&(q=w+1);k=.02*(c-b);m=.02*(g-d);t=.02*(q-w);a=b-k;k=c+k;u=d-m;m=g+m;f=w-t;
t=q+t;0>a&&0<=b&&(a=.98*b);0<k&&0>=c&&(k=0);0>u&&0<=d&&(u=.98*d);0<m&&0>=g&&(m=0);0>f&&0<=w&&(f=.98*w);0<t&&0>=q&&(t=0);b=this.GetObject();-1111!=b.fMinimum&&(f=b.fMinimum);-1111!=b.fMaximum&&(t=b.fMaximum);c=e.CreateHistogram("TH2I",10,10);c.fName=b.fName+"_h";c.fTitle=b.fTitle;c.fXaxis.fXmin=a;c.fXaxis.fXmax=k;c.fYaxis.fXmin=u;c.fYaxis.fXmax=m;c.fZaxis.fXmin=f;c.fZaxis.fXmax=t;c.fMinimum=f;c.fMaximum=t;c.fBits|=e.TH1StatusBits.kNoStats;return c};X.prototype.Graph2DTooltip=function(a){if(isNaN(a.index))return console.error("intersect.index not provided, check three.js version",
g.REVISION,"expected r97"),null;var b=Math.floor(a.index/this.nvertex);if(0>b||b>=this.index.length)return null;b=this.index[b];var c=this.painter,d=c.grx(this.graph.fX[b]),e=c.gry(this.graph.fY[b]),w=c.grz(this.graph.fZ[b]);if(this.check_next&&b+1<this.graph.fX.length){var q=function(a){return a*a};a=a.point;var k=c.grx(this.graph.fX[b+1]),u=c.gry(this.graph.fY[b+1]),m=c.grz(this.graph.fZ[b+1]);q(a.x-k)+q(a.y-u)+q(a.z-m)<q(a.x-d)+q(a.y-e)+q(a.z-w)&&(d=k,e=u,w=m,b++)}return{x1:d-this.scale0,x2:d+
this.scale0,y1:e-this.scale0,y2:e+this.scale0,z1:w-this.scale0,z2:w+this.scale0,color:this.tip_color,lines:[this.tip_name,"pnt: "+b,"x: "+c.AxisAsText("x",this.graph.fX[b]),"y: "+c.AxisAsText("y",this.graph.fY[b]),"z: "+c.AxisAsText("z",this.graph.fZ[b])]}};X.prototype.PointsCallback=function(a,b){e.extend(b,a);b.tip_name=this.GetTipName();b.tooltip=this.Graph2DTooltip;b.painter.toplevel.add(b);this.points_callback_cnt--;this.CheckCallbacks()};X.prototype.CheckCallbacks=function(){if(!(0<this.points_callback_cnt)){var a=
this.frame_painter();a&&a.Render3D(100);this._drawing_ready||(this.DrawingReady(),this._drawing_ready=!0)}};X.prototype.Redraw=function(){function a(a,b){for(var e=0,f=0;f<d.fNpoints;++f)d.fX[f]<c.scale_xmin||d.fX[f]>c.scale_xmax||d.fY[f]<c.scale_ymin||d.fY[f]>c.scale_ymax||d.fZ[f]<a||d.fZ[f]>=b||++e;return e}var b=this.main_painter(),c=this.frame_painter(),d=this.GetObject(),z=1;if(d&&b&&c&&c.mode3d){if(0<e.gStyle.OptimizeDraw&&!c.webgl){var w=a(c.scale_zmin,c.scale_zmax);5E4<w&&(z=Math.floor(w/
5E4),2>=z&&(z=2))}var q=new e.TAttMarkerHandler(d);w=null;var k=[c.scale_zmin,c.scale_zmax];q=c.size_xy3d/100*q.GetFullSize();this.options.Circles&&(q=.06*c.size_xy3d);c.usesvg&&(q*=.3);this.options.Color&&(k=b.GetContour(),w=b.GetPalette());this.points_callback_cnt=k.length-1;for(b=0;b<k.length-1;++b){var u=Math.max(k[b],c.scale_zmin),m=Math.min(k[b+1],c.scale_zmax);if(u>=m)this.points_callback_cnt--;else{var f=Math.floor(a(u,m)/z),t=null,y=0,l=new Int32Array(f),p=0,h=null,n=null,v=0,r=0;if(this.options.Markers||
this.options.Circles)t=new e.Painter.PointsCreator(f,c.webgl,q/3);this.options.Error&&(h=new Float32Array(18*f));this.options.Line&&(n=new Float32Array(6*(f-1)));for(f=0;f<d.fNpoints;++f)if(!(d.fX[f]<c.scale_xmin||d.fX[f]>c.scale_xmax||d.fY[f]<c.scale_ymin||d.fY[f]>c.scale_ymax||d.fZ[f]<u||d.fZ[f]>=m)){if(1<z&&(y=(y+1)%z,0!==y))continue;l[p++]=f;var D=c.grx(d.fX[f]),A=c.gry(d.fY[f]),B=c.grz(d.fZ[f]);t&&t.AddPoint(D,A,B);h&&(h[v]=c.grx(d.fX[f]-d.fEX[f]),h[v+1]=A,h[v+2]=B,h[v+3]=c.grx(d.fX[f]+d.fEX[f]),
h[v+4]=A,h[v+5]=B,v+=6,h[v]=D,h[v+1]=c.gry(d.fY[f]-d.fEY[f]),h[v+2]=B,h[v+3]=D,h[v+4]=c.gry(d.fY[f]+d.fEY[f]),h[v+5]=B,v+=6,h[v]=D,h[v+1]=A,h[v+2]=c.grz(d.fZ[f]-d.fEZ[f]),h[v+3]=D,h[v+4]=A,h[v+5]=c.grz(d.fZ[f]+d.fEZ[f]),v+=6);n&&(6<=r&&(n[r]=n[r-3],n[r+1]=n[r-2],n[r+2]=n[r-1],r+=3),n[r]=D,n[r+1]=A,n[r+2]=B,r+=3)}n&&3<r&&n.length==r&&(u=this.get_color(this.GetObject().fLineColor),u=new g.LineBasicMaterial({color:new g.Color(u)}),e.browser.isIE||(u.linewidth=this.GetObject().fLineWidth),n=e.Painter.createLineSegments(n,
u),c.toplevel.add(n),n.graph=d,n.index=l,n.painter=c,n.scale0=.7*q,n.tip_name=this.GetTipName(),n.tip_color=3===d.fMarkerColor?16711680:65280,n.nvertex=2,n.check_next=!0,n.tooltip=this.Graph2DTooltip);h&&(u=this.get_color(this.GetObject().fLineColor),u=new g.LineBasicMaterial({color:new g.Color(u)}),e.browser.isIE||(u.linewidth=this.GetObject().fLineWidth),h=e.Painter.createLineSegments(h,u),c.toplevel.add(h),h.graph=d,h.index=l,h.painter=c,h.scale0=.7*q,h.tip_name=this.GetTipName(),h.tip_color=3===
d.fMarkerColor?16711680:65280,h.nvertex=6,h.tooltip=this.Graph2DTooltip);t?(h="blue",this.options.Circles||(h=w?w.calcColor(b,k.length):this.get_color(d.fMarkerColor)),t.AssignCallback(this.PointsCallback.bind(this,{graph:d,index:l,painter:c,scale0:.3*q,tip_color:3===d.fMarkerColor?16711680:65280})),t.CreatePoints({color:h,style:this.options.Circles?4:d.fMarkerStyle})):this.points_callback_cnt--}}this.CheckCallbacks()}};e.Painter.drawGraph2D=function(a,b,c){var d=new e.TGraph2DPainter(b);d.SetDivId(a,
-1);d.DecodeOptions(c);if(d.main_painter())return d.SetDivId(a),d.Redraw(),d;b.fHistogram||(b.fHistogram=d.CreateHistogram());e.draw(a,b.fHistogram,"lego;axis",function(b){d.ownhisto=!0;d.SetDivId(a);d.Redraw()});return d};e.Painter.drawPolyMarker3D=function(a,b,c){var d=new e.TObjectPainter(b);d.SetDivId(a);d.Redraw=function(){var a=this.frame_painter();if(a&&a.mode3d){for(var c=1,q=0,k=0;k<b.fP.length;k+=3)b.fP[k]<a.scale_xmin||b.fP[k]>a.scale_xmax||b.fP[k+1]<a.scale_ymin||b.fP[k+1]>a.scale_ymax||
b.fP[k+2]<a.scale_zmin||b.fP[k+2]>a.scale_zmax||++q;0<e.gStyle.OptimizeDraw&&5E4<q&&(c=Math.floor(q/5E4),2>=c&&(c=2));k=Math.floor(q/c);var u=new e.Painter.PointsCreator(k,a.webgl,a.size_xy3d/100),m=new Int32Array(k),f=q=0;for(k=0;k<b.fP.length;k+=3)if(!(b.fP[k]<a.scale_xmin||b.fP[k]>a.scale_xmax||b.fP[k+1]<a.scale_ymin||b.fP[k+1]>a.scale_ymax||b.fP[k+2]<a.scale_zmin||b.fP[k+2]>a.scale_zmax)){if(1<c&&(q=(q+1)%c,0!==q))continue;m[f++]=k;u.AddPoint(a.grx(b.fP[k]),a.gry(b.fP[k+1]),a.grz(b.fP[k+2]))}u.AssignCallback(function(c){a.toplevel.add(c);
c.tip_color=3===b.fMarkerColor?16711680:65280;c.tip_name=b.fName||"Poly3D";c.poly=b;c.painter=a;c.scale0=.7*u.scale;c.index=m;c.tooltip=function(a){if(isNaN(a.index))return console.error("intersect.index not provided, check three.js version",g.REVISION,"expected r97"),null;a=Math.floor(a.index/this.nvertex);if(0>a||a>=this.index.length)return null;a=this.index[a];var b=this.painter,c=b.grx(this.poly.fP[a]),d=b.gry(this.poly.fP[a+1]),e=b.grz(this.poly.fP[a+2]);return{x1:c-this.scale0,x2:c+this.scale0,
y1:d-this.scale0,y2:d+this.scale0,z1:e-this.scale0,z2:e+this.scale0,color:this.tip_color,lines:[this.tip_name,"pnt: "+a/3,"x: "+b.AxisAsText("x",this.poly.fP[a]),"y: "+b.AxisAsText("y",this.poly.fP[a+1]),"z: "+b.AxisAsText("z",this.poly.fP[a+2])]}};a.Render3D(100);d._did_redraw||d.DrawingReady();d._did_redraw=!0});u.CreatePoints({color:this.get_color(b.fMarkerColor),style:b.fMarkerStyle})}else this._did_redraw||this.DrawingReady(),this._did_redraw=!0};d.Redraw();return d};e.TH3Painter=Q;e.TGraph2DPainter=
X;return e});
